<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>WebAR: 画像から3Dキャラ&キーワード（安定版）</title>

  <!-- A-Frame → MindAR の順で読み込み -->
  <script src="https://unpkg.com/aframe@1.5.0/dist/aframe.min.js"></script>
  <script src="https://unpkg.com/mind-ar@1.2.2/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; }
    .bar {
      position: fixed; top:0; left:0; right:0; z-index: 20;
      background: rgba(0,0,0,.55); color:#fff; padding:8px 12px; text-align:center;
      font: 14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial;
      backdrop-filter: blur(4px);
    }
    .permission { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#000; color:#fff; z-index:9999; }
    .permission.hidden{ display:none; }
    .box { text-align:center; padding:24px; }
    .btn {
      appearance:none; border:none; cursor:pointer; border-radius:12px;
      padding:12px 16px; font-weight:700; background:#13a10e; color:#fff; margin-top:12px;
      box-shadow:0 6px 16px rgba(0,0,0,.35);
    }
    .btn:active{ transform: translateY(1px); }
    .warn { color:#ffd166; font-size:13px; margin-top:8px; }
    .card {
      position: fixed; left:50%; bottom:24px; transform: translateX(-50%);
      width:min(92vw,480px); background:rgba(255,255,255,.95); color:#111; border-radius:14px;
      box-shadow:0 8px 20px rgba(0,0,0,.35); padding:14px; z-index: 20; display:none;
      font: 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica Neue,Arial;
    }
    .title{ font-weight:700; margin-bottom:6px; }
    .mono{
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace;
      font-size:18px; background:#f4f4f6; border-radius:8px; padding:8px 10px; overflow-wrap:anywhere; border:1px solid rgba(0,0,0,.06);
    }
    .row{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:10px; }
    .toast{ position:fixed; left:50%; bottom:100px; transform:translateX(-50%); background:rgba(0,0,0,.85); color:#fff; border-radius:999px; padding:8px 14px; font-size:14px; display:none; z-index:20; }
  </style>
</head>
<body>
  <!-- in-app browser 警告（LINE/Twitter/Instagramなど） -->
  <div class="bar" id="info">ポスターにかざしてください…</div>

  <!-- 許可ガイド→ボタン起点で権限を先取り（iOS重要） -->
  <div id="perm" class="permission">
    <div class="box">
      <h1 style="font-size:20px;margin:0 0 10px;">カメラアクセスの許可</h1>
      <p>「開始」を押すとカメラが起動します。ポスターにかざしてください。</p>
      <button id="startBtn" class="btn">開始</button>
      <div class="warn" id="iabWarn" style="display:none;">アプリ内ブラウザの可能性があります。右上メニューから「Safari/Chromeで開く」を選んでください。</div>
    </div>
  </div>

  <!-- 合言葉カード -->
  <div class="card" id="card">
    <div class="title">合言葉</div>
    <div class="mono" id="kw"></div>
    <div class="row">
      <small id="status">キャラをタップすると表示されます</small>
      <button class="btn" id="copyBtn" style="background:#111;">コピー</button>
    </div>
  </div>
  <div class="toast" id="toast">コピーしました</div>

  <!-- A-Frame + MindAR シーン -->
  <a-scene
    id="scene"
    embedded
    color-space="sRGB"
    renderer="colorManagement: true, physicallyCorrectLights: true, antialias: true, alpha: true"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false"
    mindar-image="imageTargetSrc: assets/target.mind; maxTrack: 1; warmupTolerance: 5; "
  >
    <a-assets timeout="15000">
      <a-asset-item id="model" src="assets/mascot.glb" response-type="arraybuffer"></a-asset-item>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <a-entity id="anchor" mindar-image-target="targetIndex: 0">
      <a-entity id="char"
                gltf-model="#model"
                position="0 0 0"
                scale="0.6 0.6 0.6"
                animation-mixer="clip:*; loop:repeat;"
                shadow="cast:true; receive:false"></a-entity>
      <a-entity light="type: ambient; intensity: 1.0"></a-entity>
      <a-entity light="type: directional; intensity: 1.2" position="0 1 1"></a-entity>
    </a-entity>
  </a-scene>

  <script>
    // ==== 設定 ====
    const SECRET_KEYWORD = "KAICHI-2025"; // ←合言葉
    const env = {
      isIPhone: /iPhone|iPad|iPod/i.test(navigator.userAgent),
      isIAB: /(Line|Instagram|FBAN|FBAV|Twitter|WeChat|MicroMessenger)/i.test(navigator.userAgent) // アプリ内ブラウザ
    };

    // 要素取得
    const perm = document.getElementById('perm');
    const iabWarn = document.getElementById('iabWarn');
    const startBtn = document.getElementById('startBtn');
    const info = document.getElementById('info');

    const sceneEl = document.getElementById('scene');
    const anchor = document.getElementById('anchor');
    const card = document.getElementById('card');
    const kw = document.getElementById('kw');
    const statusEl = document.getElementById('status');
    const copyBtn = document.getElementById('copyBtn');
    const toast = document.getElementById('toast');

    if (env.isIAB) iabWarn.style.display = 'block';

    // --- 重要：iOSは先に getUserMedia で権限を確保し、その後 MindAR.start() ---
    async function preflightCamera() {
      if (!navigator.mediaDevices?.getUserMedia) throw new Error("getUserMedia not supported");
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: 'environment' } }, audio: false
      });
      // 権限が取れたことだけ確認して、すぐに止める（MindARが自前で起動する）
      for (const track of stream.getTracks()) track.stop();
    }

    async function startAR() {
      // MindAR の start は A-Frame の初期化後に呼ぶ
      const comp = sceneEl.components['mindar-image'];
      if (!comp) {
        // 初期化が未完なら少し待つ
        await new Promise(r => setTimeout(r, 100));
      }
      await sceneEl.components['mindar-image'].start();
    }

    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true;
      try {
        await preflightCamera(); // ← ここで権限ダイアログが出る（iOS）
        perm.classList.add('hidden');
        await startAR();
        info.textContent = "ポスターにゆっくり近づけてください…";
      } catch (e) {
        console.error(e);
        info.textContent = "カメラを利用できません。ブラウザの設定でカメラ許可をONにしてください。";
        startBtn.disabled = false;
      }
    });

    // ターゲット検出イベント
    anchor.addEventListener('targetFound', () => {
      info.textContent = "認識しました！キャラクターをタップして合言葉を表示";
    });
    anchor.addEventListener('targetLost', () => {
      info.textContent = "ポスターにゆっくり近づけてください…";
    });

    // 合言葉表示（簡易仕様：検出中に画面タップ）
    window.addEventListener('click', () => {
      if (!anchor.object3D.visible) return;
      kw.textContent = SECRET_KEYWORD;
      statusEl.textContent = "受付でこの合言葉を伝えてください。";
      card.style.display = 'block';
    });

    // クリップボードコピー
    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(SECRET_KEYWORD);
        toast.textContent = "コピーしました";
      } catch {
        toast.textContent = "コピーできない場合、手入力してください";
      }
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display='none', 1300);
    });

    // タブ復帰時（iOSでカメラが止まることがあるため再開）
    document.addEventListener('visibilitychange', async () => {
      if (document.visibilityState === 'visible' && !perm.classList.contains('hidden')) return;
      try {
        const comp = sceneEl.components['mindar-image'];
        if (comp && !comp.video) { await startAR(); }
      } catch {}
    });
  </script>
</body>
</html>
